[核心架构](#核心架构)
[客户端重定向：MOVED与ASK](#客户端重定向：MOVED与ASK)
[故障检测与自动切换](#故障检测与自动切换)
[集群限制](#集群限制)
[常见误区](#常见误区)

Redis Cluster 是 Redis 官方提供的去中心化分布式解决方案（从 Redis 3.0 开始引入），主要解决单机 Redis 的容量、性能和单点故障问题。

#### 核心架构

1. 分片方式： **哈希槽**分片不是一致性哈希，16384个槽，计算公式 CRC16(key) % 16384 = slot
2. 每个master负责一部分槽，可动态迁移
3. 每个master可配置0~N个slave，推荐至少一个
4. 通信方式：节点间互联，使用**Gossip协议**（cluster bus，16379端口）
5. 最小推荐规模：只是3master+各自slave，生产建议3~6master起步
6. 最大节点建议：官方无硬限制，社区经验100~1000个节点

#### 客户端重定向：MOVED与ASK

由于客户端可以随机连接集群中任何一个节点，当请求的key不在该节点上负责的槽位时：
1. MOVED重定向：节点告诉客户端，这个槽位属于节点X
2. ASK重定向：发生在扩容缩容期间，表示这个槽位正在迁移到节点Y

#### 故障检测与自动切换

| 阶段          | 条件                                 | 谁来判定      | 时间窗口（默认）  |
| ----------- | ---------------------------------- | --------- | --------- |
| 主观下线（pfail） | 一个节点 ping 超时（cluster-node-timeout） | 单个节点      | ~15秒      |
| 客观下线（fail）  | 超过半数 master 认为它 pfail              | 集群多数派     | 通常 15~30秒 |
| 故障转移        | slave 竞争成为新 master（raft-like 投票）   | 所有 master | 几秒 ~ 几十秒  |
|             |                                    |           |           |
#### 集群限制

1. 不支持跨slot的多key操作,如果key1 key2不在同一个slot
```
MGET key1 key2
```

解决方案Hash Tag，只对{}内计算Hash
```
user:{1001}:name
user:{1001}:age

```

2. 不支持多DB，只能用DB0
3. Lua脚本中所有key必须在同一个slot
#### 常见误区

1. 认为slave可以随便读，默认slave不对外服务请求
2. cluster节点越多越好，节点超过500个，gossip压力明显，建议分多个小集群
